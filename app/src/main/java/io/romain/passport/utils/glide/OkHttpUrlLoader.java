/*
 *    Copyright 2016 Romain
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *        http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package io.romain.passport.utils.glide;

import android.content.Context;

import com.bumptech.glide.load.data.DataFetcher;
import com.bumptech.glide.load.model.GenericLoaderFactory;
import com.bumptech.glide.load.model.GlideUrl;
import com.bumptech.glide.load.model.ModelLoader;
import com.bumptech.glide.load.model.ModelLoaderFactory;
import com.squareup.okhttp.OkHttpClient;

import java.io.InputStream;

class OkHttpUrlLoader implements ModelLoader<GlideUrl, InputStream> {

	/**
	 * The default factory for {@link OkHttpUrlLoader}s.
	 */
	public static class Factory implements ModelLoaderFactory<GlideUrl, InputStream> {
		private static volatile OkHttpClient internalClient;
		private final OkHttpClient client;

		private static OkHttpClient getInternalClient() {
			if (internalClient == null) {
				synchronized (Factory.class) {
					if (internalClient == null) {
						internalClient = new OkHttpClient();
					}
				}
			}
			return internalClient;
		}

		/**
		 * Constructor for a new Factory that runs requests using a static singleton client.
		 */
		public Factory() {
			this(getInternalClient());
		}

		/**
		 * Constructor for a new Factory that runs requests using given client.
		 */
		public Factory(OkHttpClient client) {
			this.client = client;
		}

		@Override
		public ModelLoader<GlideUrl, InputStream> build(Context context, GenericLoaderFactory factories) {
			return new OkHttpUrlLoader(client);
		}

		@Override
		public void teardown() {
			// Do nothing, this instance doesn't own the client.
		}
	}

	private final OkHttpClient client;

	private OkHttpUrlLoader(OkHttpClient client) {
		this.client = client;
	}

	@Override
	public DataFetcher<InputStream> getResourceFetcher(GlideUrl model, int width, int height) {
		return new OkHttpStreamFetcher(client, model);
	}
}
